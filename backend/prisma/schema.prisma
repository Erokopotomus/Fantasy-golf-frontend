// Prisma Schema for Clutch Fantasy Sports
// Redesigned to accommodate rich golf API data (SportsDataIO, DataGolf)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USER & AUTH ============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teams          Team[]
  leagues        LeagueMember[]
  ownedLeagues   League[]       @relation("LeagueOwner")
  trades         Trade[]        @relation("TradeInitiator")
  receivedTrades Trade[]        @relation("TradeReceiver")
  messages       Message[]
  notifications  Notification[]
  picks          Pick[]

  // Manager Analytics relations
  managerProfiles        ManagerProfile[]
  h2hRecords             HeadToHeadRecord[]  @relation("H2HUser")
  h2hOpponentRecords     HeadToHeadRecord[]  @relation("H2HOpponent")
  achievementUnlocks     AchievementUnlock[]
  managerSeasonSummaries ManagerSeasonSummary[]
  mockDraftResults       MockDraftResult[]

  // Push notifications
  pushTokens              PushToken[]
  notificationPreferences Json    @default("{}")

  // Predictions
  predictions     Prediction[]
  reputations     UserReputation[]

  // League History / Migration
  leagueImports       LeagueImport[]
  historicalSeasons    HistoricalSeason[]    @relation("HistoricalOwner")

  // OAuth tokens (Yahoo, etc.)
  oauthTokens         UserOAuthToken[]

  // Workspace / The Lab
  draftBoards      DraftBoard[]
  watchListEntries WatchListEntry[]
  boardActivities  BoardActivity[]
  labCaptures      LabCapture[]
  labInsight       LabInsightCache?
  labCheatSheets   LabCheatSheet[]
  opinionEvents    PlayerOpinionEvent[]
  intelligenceProfiles UserIntelligenceProfile[]
  aiInsights           AiInsight[]
  aiReports            AiReport[]
  aiPreferences        Json     @default("{\"ambient\":true,\"draftCoaching\":true,\"boardCoaching\":true,\"predictionCoaching\":true}")

  // Custom league data imports
  customLeagueDataImports CustomLeagueData[]

  // League intelligence
  leagueQuerySessions LeagueQuerySession[]

  // Owner alias mapping
  ownerAliases        OwnerAlias[]

  // Phase 5: Manager profile + Clutch Rating
  username    String?  @unique @db.VarChar(30)
  bio         String?  @db.Text
  tagline     String?  @db.VarChar(280)
  socialLinks Json     @default("{}") @map("social_links")
  pinnedBadges Json    @default("[]") @map("pinned_badges")
  clutchManagerRating ClutchManagerRating?

  @@map("users")
}

// ============ LEAGUES ============

model League {
  id         String       @id @default(cuid())
  name       String
  sport      String       @default("GOLF")
  format     LeagueFormat @default(FULL_LEAGUE)
  draftType  DraftType    @default(SNAKE)
  status     LeagueStatus @default(DRAFT_PENDING)
  inviteCode String       @unique @default(cuid())
  maxTeams   Int          @default(10)
  isPublic   Boolean      @default(false)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Owner
  ownerId String
  owner   User   @relation("LeagueOwner", fields: [ownerId], references: [id])

  // Sport & Scoring links
  sportId         String?
  sportRef        Sport?         @relation("LeagueSport", fields: [sportId], references: [id])
  scoringSystemId String?
  scoringSystem   ScoringSystem? @relation("LeagueScoring", fields: [scoringSystemId], references: [id])

  // Settings stored as JSON (scoring rules, roster settings, etc.)
  settings Json @default("{}")

  // Relations
  members       LeagueMember[]
  teams         Team[]
  drafts        Draft[]
  trades        Trade[]
  messages      Message[]
  matchups      Matchup[]
  picks         Pick[]
  leagueSeasons LeagueSeason[]
  rosterSlots   RosterSlotDefinition[] @relation("LeagueRosterSlots")
  waiverClaims     WaiverClaim[]
  predictions      Prediction[]
  leagueImports    LeagueImport[]    @relation("LeagueImports")
  historicalSeasons HistoricalSeason[] @relation("LeagueHistory")

  // Draft dollar tracking
  draftDollarTransactions DraftDollarTransaction[]

  // Custom league data (spreadsheet/website imports)
  customLeagueData CustomLeagueData[]

  // League intelligence
  querySessions   LeagueQuerySession[]
  statsCache      LeagueStatsCache?

  // Owner alias mapping (commissioner-managed)
  ownerAliases    OwnerAlias[]

  @@map("leagues")
}

model LeagueMember {
  id       String     @id @default(cuid())
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  userId   String
  user     User   @relation(fields: [userId], references: [id])
  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@map("league_members")
}

// ============ TEAMS & ROSTERS ============

model Team {
  id          String   @id @default(cuid())
  name        String
  avatar      String?
  avatarUrl   String?
  totalPoints Float    @default(0)
  wins        Int      @default(0)
  losses      Int      @default(0)
  ties        Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId   String
  user     User   @relation(fields: [userId], references: [id])
  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Relations
  roster             RosterEntry[]
  homeMatchups       Matchup[]           @relation("HomeTeam")
  awayMatchups       Matchup[]           @relation("AwayTeam")
  draftPicks         DraftPick[]
  sentTrades         Trade[]             @relation("TradeSender")
  receivedTrades     Trade[]             @relation("TradeReceiver")
  teamSeasons        TeamSeason[]
  weeklyResults      WeeklyTeamResult[]
  lineupSnapshots    LineupSnapshot[]
  rosterTransactions RosterTransaction[]
  budgets            TeamBudget[]
  waiverClaims       WaiverClaim[]
  draftGrades        DraftGrade[]

  // Draft dollar tracking
  draftDollarAccounts  DraftDollarAccount[]
  draftDollarsSent     DraftDollarTransaction[] @relation("DollarFrom")
  draftDollarsReceived DraftDollarTransaction[] @relation("DollarTo")

  @@unique([userId, leagueId])
  @@map("teams")
}

model RosterEntry {
  id           String   @id @default(cuid())
  position     String   @default("BENCH") // ACTIVE, BENCH, IR (legacy)
  rosterStatus String   @default("BENCH") // ACTIVE, BENCH, IR (canonical)
  acquiredAt   DateTime @default(now())
  acquiredVia  String   @default("DRAFT") // DRAFT, WAIVER, TRADE, FREE_AGENT

  // Soft-delete support
  isActive  Boolean   @default(true)
  droppedAt DateTime?

  // Keeper league support
  isKeeper        Boolean   @default(false)
  keeperCost      Int?
  keeperYear      Int?
  keptAt          DateTime?
  keeperYearsKept Int       @default(0) // Consecutive years kept (0 = never, 1 = first year, etc.)

  teamId   String
  team     Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  // Relations
  slotAssignments RosterSlotAssignment[]

  @@unique([teamId, playerId])
  @@index([teamId, isActive])
  @@map("roster_entries")
}

// ============ PLAYERS (Expanded for API data) ============

model Player {
  id String @id @default(cuid())

  // External IDs for cross-platform matching
  externalId   String? @unique // Primary API ID (SportsDataIO)
  datagolfId   String? @unique // DataGolf ID
  pgaTourId    String? // PGA Tour ID
  sportRadarId String? // SportRadar ID
  draftKingsId String? // DraftKings ID
  fanDuelId    String? // FanDuel ID
  yahooId      String? // Yahoo ID
  espnId       String? // ESPN ID
  sleeperId    String? // Sleeper ID
  mflId        String? // MyFantasyLeague ID
  fantraxId    String? // Fantrax ID

  // NFL IDs (nflverse)
  gsisId       String? @unique // NFL GSIS player ID
  pfrId        String? // Pro-Football-Reference ID
  nflPosition  String? // QB, RB, WR, TE, K, DEF, etc.
  nflTeamAbbr  String? // Current NFL team abbreviation (KC, BAL, etc.)
  nflNumber    Int?    // Jersey number

  // Basic Info
  firstName String?
  lastName  String?
  name      String // Full name for display

  // Bio
  country     String?
  countryFlag String?
  birthCity   String?
  birthState  String?
  birthDate   DateTime?
  college     String?
  turnedPro   Int? // Year turned pro
  pgaDebut    Int? // Year of PGA debut
  weight      Int? // In pounds
  height      String? // e.g., "6'1"
  swings      String? // R or L

  // Images
  headshotUrl     String? // Primary headshot
  headshotBgUrl   String? // Headshot with background
  headshotNoBgUrl String? // Headshot transparent background

  // Rankings
  owgr          Float? // Official World Golf Ranking points
  owgrRank      Int? // OWGR position
  fedexRank     Int? // FedEx Cup ranking
  fedexPoints   Float? // FedEx Cup points
  datagolfRank  Int? // DataGolf skill ranking
  datagolfSkill Float? // DataGolf skill estimate

  // Season Stats
  events   Int   @default(0)
  wins     Int   @default(0)
  top5s    Int   @default(0)
  top10s   Int   @default(0)
  top25s   Int   @default(0)
  cutsMade Int   @default(0)
  earnings Float @default(0)

  // Scoring Stats
  avgScore           Float?
  scoringAvg         Float? // Official scoring average
  adjustedScoringAvg Float? // Adjusted for field strength
  birdieAvg          Float? // Birdies per round
  eaglesTotal        Int    @default(0)
  holesInOne         Int    @default(0)
  bogeyFreeRounds    Int    @default(0)

  // Strokes Gained (Comprehensive)
  sgTotal        Float? // Total strokes gained
  sgPutting      Float? // SG: Putting
  sgAroundGreen  Float? // SG: Around the Green
  sgApproach     Float? // SG: Approach the Green
  sgOffTee       Float? // SG: Off the Tee
  sgTeeToGreen   Float? // SG: Tee to Green (OTT + APP + ARG)
  sgBallStriking Float? // SG: Ball Striking (OTT + APP)

  // Traditional Stats
  drivingDistance      Float? // Average driving distance
  drivingAccuracy      Float? // Fairways hit %
  gir                  Float? // Greens in Regulation %
  scrambling           Float? // Scrambling % (up-and-down)
  sandSaves            Float? // Sand save %
  puttsPerRound        Float? // Average putts per round
  onePointPercentage   Float? // 1-putt %
  threePointPercentage Float? // 3-putt %

  // Proximity Stats (from DataGolf)
  proximityOverall Float? // Average proximity to hole
  proximityFairway Float? // Proximity from fairway
  proximityRough   Float? // Proximity from rough
  goodShotPct      Float? // % of "good" shots
  poorShotPct      Float? // % of "poor" shots

  // Status
  isActive    Boolean @default(true)
  isAmateur   Boolean @default(false)
  primaryTour String? // PGA, DP World, LIV, Korn Ferry, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sport link (nullable for backward compat)
  sportId String?
  sportRef Sport? @relation("PlayerSport", fields: [sportId], references: [id])

  // Source tracking
  sourceProvider      String?
  sourceIngestedAt    DateTime?
  clutchTransformedAt DateTime?

  // Relations
  rosters            RosterEntry[]
  draftPicks         DraftPick[]
  picks              Pick[]
  performances       Performance[]
  roundScores        RoundScore[]
  predictions        PlayerPrediction[]
  courseHistory      PlayerCourseHistory[]
  dfsEntries         PlayerDFSEntry[]
  fantasyScores      FantasyScore[]
  seasonStats        PlayerSeasonStats[]
  rosterTransactions RosterTransaction[]
  adpEntries         ADPEntry[]
  consistency        PlayerConsistency[]
  ownershipRates     OwnershipRate[]
  draftValueTrackers DraftValueTracker[]
  positions          PlayerPosition[]
  tagAssignments     PlayerTagAssignment[]
  sportProfiles      SportPlayerProfile[]
  waiverClaims       WaiverClaim[]
  clutchScores       ClutchScore[]
  nflPlayerGames     NflPlayerGame[]
  propLines          PropLine[]
  draftBoardEntries  DraftBoardEntry[]
  clutchProjections  ClutchProjection[]
  watchListEntries   WatchListEntry[]
  labCaptureLinks    LabCapturePlayer[]

  @@index([owgrRank])
  @@index([name])
  @@index([gsisId])
  @@map("players")
}

// ============ COURSES ============

model Course {
  id         String  @id @default(cuid())
  externalId String? @unique

  name     String
  nickname String? // e.g., "The Stadium Course"
  city     String?
  state    String?
  country  String?
  zipCode  String?
  timezone String?

  // Course specs
  par        Int?
  yardage    Int?
  grassType  String? // e.g., "Bermuda", "Bentgrass"
  greenSpeed Float? // Stimpmeter reading
  elevation  Int? // Feet above sea level

  // Design
  architect String?
  yearBuilt Int?

  // Course characteristics (for course fit analysis)
  drivingImportance     Float? // How much driving matters (0-1)
  approachImportance    Float? // How much approach matters (0-1)
  aroundGreenImportance Float? // How much short game matters (0-1)
  puttingImportance     Float? // How much putting matters (0-1)

  imageUrl String?

  // Coordinates (for weather lookups)
  latitude  Float?
  longitude Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  holes         Hole[]
  tournaments   Tournament[]
  playerHistory PlayerCourseHistory[]
  weather       Weather[]

  @@map("courses")
}

model Hole {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  number      Int // 1-18
  par         Int
  yardage     Int?
  handicap    Int? // Difficulty ranking 1-18
  description String? // Notable features

  // Relations
  holeScores HoleScore[]

  @@unique([courseId, number])
  @@map("holes")
}

// ============ TOURNAMENTS (Expanded) ============

model Tournament {
  id          String  @id @default(cuid())
  externalId  String? @unique
  datagolfId  String? @unique
  espnEventId String? // ESPN Scoreboard event ID

  name      String
  shortName String? // Abbreviated name

  // Venue
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id])
  location String? // Fallback location text

  // Schedule
  startDate DateTime
  endDate   DateTime
  timezone  String?

  // Tournament info
  purse       Float?
  winnerShare Float? // Winner's prize amount
  fedexPoints Float? // FedEx points available
  owgrPoints  Float? // OWGR points available

  format      TournamentFormat @default(STROKE)
  tour        String? // PGA, DP World, LIV, etc.
  isMajor     Boolean          @default(false)
  isPlayoff   Boolean          @default(false) // FedEx playoff event
  isSignature Boolean          @default(false) // Signature event (elevated)

  // Live state
  status         TournamentStatus @default(UPCOMING)
  currentRound   Int              @default(0)
  cutLine        Int? // Score to make cut
  isWeatherDelay Boolean          @default(false)

  // Field
  fieldSize Int?

  // Source tracking
  sourceProvider      String?
  sourceIngestedAt    DateTime?
  clutchTransformedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  performances Performance[]
  roundScores  RoundScore[]
  holeScores   HoleScore[]
  matchups     Matchup[]
  picks        Pick[]
  predictions  PlayerPrediction[]
  bettingOdds  BettingOdds[]
  dfsSlates    DFSSlate[]
  weather      Weather[]
  liveScores   LiveScore[]
  fantasyWeeks FantasyWeek[]
  clutchScores ClutchScore[]
  eventIdMap   ClutchEventIdMap?

  @@map("tournaments")
}

// ============ PERFORMANCE & SCORING ============

model Performance {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId     String
  player       Player     @relation(fields: [playerId], references: [id])

  // Result
  position     Int? // Final position (T5 = 5)
  positionTied Boolean @default(false)
  status       String? // ACTIVE, CUT, WD, DQ

  // Scores
  totalScore Int? // Total strokes
  totalToPar Int? // Score relative to par
  round1     Int?
  round2     Int?
  round3     Int?
  round4     Int?

  // Money & Points
  earnings    Float @default(0)
  fedexPoints Float @default(0)
  owgrPoints  Float @default(0)

  // Fantasy Points (multiple scoring systems)
  fantasyPoints Float  @default(0) // Your default scoring
  dkPoints      Float? // DraftKings points
  fdPoints      Float? // FanDuel points
  yahooPoints   Float? // Yahoo points

  // Tournament-level stats
  eagles          Int @default(0)
  birdies         Int @default(0)
  pars            Int @default(0)
  bogeys          Int @default(0)
  doubleBogeys    Int @default(0)
  worseThanDouble Int @default(0)

  // Strokes Gained for this tournament
  sgTotal       Float?
  sgPutting     Float?
  sgAroundGreen Float?
  sgApproach    Float?
  sgOffTee      Float?
  sgTeeToGreen  Float?

  // Source tracking
  sourceProvider      String?
  sourceIngestedAt    DateTime?
  clutchTransformedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tournamentId, playerId])
  @@index([position])
  @@map("performances")
}

model RoundScore {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId     String
  player       Player     @relation(fields: [playerId], references: [id])

  roundNumber Int // 1-4
  score       Int? // Total strokes this round
  toPar       Int? // Round score to par

  teeTime      DateTime? // Tee time for this round
  startingHole Int       @default(1) // For shotgun starts

  // Round stats
  eagles          Int @default(0)
  birdies         Int @default(0)
  pars            Int @default(0)
  bogeys          Int @default(0)
  doubleBogeys    Int @default(0)
  worseThanDouble Int @default(0)

  fairwaysHit      Int?
  fairwaysPossible Int?
  greensHit        Int?
  greensPossible   Int?
  putts            Int?

  // Round-level strokes gained
  sgTotal       Float?
  sgPutting     Float?
  sgAroundGreen Float?
  sgApproach    Float?
  sgOffTee      Float?

  // Driving
  longestDrive   Int?
  avgDrivingDist Float?

  // Streak tracking
  consecutiveBirdies Int     @default(0)
  bogeyFree          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  holeScores HoleScore[]

  @@unique([tournamentId, playerId, roundNumber])
  @@map("round_scores")
}

model HoleScore {
  id           String     @id @default(cuid())
  roundScoreId String
  roundScore   RoundScore @relation(fields: [roundScoreId], references: [id], onDelete: Cascade)
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  holeId       String?
  hole         Hole?      @relation(fields: [holeId], references: [id])

  holeNumber Int // 1-18
  par        Int
  score      Int?
  toPar      Int? // -2 for eagle, -1 birdie, 0 par, etc.

  // Shot details (if available)
  putts      Int?
  penalties  Int      @default(0)
  fairwayHit Boolean?
  greenHit   Boolean?
  sandShot   Boolean  @default(false)

  // Proximity (if available)
  teeDistance      Int? // Drive distance
  approachDistance Int? // Distance for approach shot
  proximityToPin   Float? // Feet from pin after approach

  createdAt DateTime @default(now())

  @@unique([roundScoreId, holeNumber])
  @@map("hole_scores")
}

// ============ LIVE SCORING ============

model LiveScore {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId     String

  // Current state
  position     Int?
  positionTied Boolean @default(false)
  totalToPar   Int?
  todayToPar   Int?
  thru         Int? // Holes completed today (null = not started, 18 = finished)
  currentRound Int?

  // Live scoring
  currentHole Int?

  // Live probabilities (from DataGolf)
  winProbability     Float?
  top5Probability    Float?
  top10Probability   Float?
  top20Probability   Float?
  makeCutProbability Float?

  // Live strokes gained
  sgTotalLive Float?

  lastUpdated DateTime @default(now())

  @@unique([tournamentId, playerId])
  @@index([position])
  @@map("live_scores")
}

// ============ PREDICTIONS ============

model PlayerPrediction {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId     String
  player       Player     @relation(fields: [playerId], references: [id])

  // Pre-tournament predictions
  winProbability     Float?
  top5Probability    Float?
  top10Probability   Float?
  top20Probability   Float?
  makeCutProbability Float?

  // Skill decomposition for this tournament
  expectedSgTotal       Float?
  expectedSgPutting     Float?
  expectedSgAroundGreen Float?
  expectedSgApproach    Float?
  expectedSgOffTee      Float?

  // Course fit score
  courseFitScore Float? // How well player's game fits the course

  // Sample size (rounds of data)
  sampleSize Int?

  source    String? // "datagolf", "sportsdata", "internal"
  createdAt DateTime @default(now())

  @@unique([tournamentId, playerId])
  @@map("player_predictions")
}

// ============ BETTING ============

model BettingOdds {
  id           String     @id @default(cuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerId     String

  sportsbook String // e.g., "DraftKings", "FanDuel", "BetMGM"
  marketType String // WIN, TOP_5, TOP_10, TOP_20, MAKE_CUT, FIRST_ROUND_LEADER

  // Odds in different formats
  americanOdds       Int? // e.g., +1500
  decimalOdds        Float? // e.g., 16.0
  impliedProbability Float? // e.g., 0.0625

  // Model comparison
  fairOdds Float? // What the odds "should" be
  edge     Float? // (impliedProb - fairProb) = betting edge

  isAvailable Boolean  @default(true)
  lastUpdated DateTime @default(now())

  @@index([tournamentId, marketType])
  @@map("betting_odds")
}

// ============ DFS (Daily Fantasy Sports) ============

model DFSSlate {
  id           String     @id @default(cuid())
  externalId   String?    @unique
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  platform  String // DRAFTKINGS, FANDUEL, YAHOO
  slateName String? // "Main Slate", "Showdown", etc.
  slateType String? // CLASSIC, SHOWDOWN, SINGLE_GAME

  startTime  DateTime?
  rosterSize Int?
  salaryCap  Int? // e.g., 50000

  createdAt DateTime @default(now())

  // Relations
  entries PlayerDFSEntry[]

  @@map("dfs_slates")
}

model PlayerDFSEntry {
  id       String   @id @default(cuid())
  slateId  String
  slate    DFSSlate @relation(fields: [slateId], references: [id], onDelete: Cascade)
  playerId String
  player   Player   @relation(fields: [playerId], references: [id])

  salary    Int? // Player's salary
  ownership Float? // Projected or actual ownership %
  value     Float? // Points per $1000

  // Projections
  projectedPoints  Float?
  projectedCeiling Float? // Upside projection
  projectedFloor   Float? // Floor projection

  // Actual results (filled after tournament)
  actualPoints    Float?
  actualOwnership Float?

  @@unique([slateId, playerId])
  @@map("player_dfs_entries")
}

// ============ PLAYER COURSE HISTORY ============

model PlayerCourseHistory {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  // Aggregated history
  rounds     Int    @default(0)
  avgScore   Float?
  avgToPar   Float?
  bestFinish Int? // Best position
  cuts       Int    @default(0)
  cutsMade   Int    @default(0)
  wins       Int    @default(0)
  top10s     Int    @default(0)

  // Course-specific strokes gained
  sgTotal    Float?
  sgPutting  Float?
  sgApproach Float?
  sgOffTee   Float?

  lastPlayed DateTime?
  updatedAt  DateTime  @updatedAt

  @@unique([playerId, courseId])
  @@map("player_course_history")
}

// ============ WEATHER ============

model Weather {
  id           String      @id @default(cuid())
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  courseId     String?
  course       Course?     @relation(fields: [courseId], references: [id])

  timestamp DateTime
  round     Int? // Which round, if applicable

  // Conditions
  temperature   Float? // Fahrenheit
  feelsLike     Float?
  humidity      Float? // Percentage
  windSpeed     Float? // MPH
  windGust      Float? // MPH
  windDirection String? // e.g., "NW"
  precipitation Float? // Inches
  conditions    String? // "Sunny", "Cloudy", "Rain", etc.

  // Impact scoring
  difficultyImpact Float? // How much harder conditions make the course

  // Hourly breakdown
  hourlyData Json? // [{ hour, temp, windSpeed, windGust, windDir, precip, weatherCode }]

  @@map("weather")
}

// ============ DRAFTS ============

model Draft {
  id           String      @id @default(cuid())
  status       DraftStatus @default(SCHEDULED)
  currentPick  Int         @default(1)
  currentRound Int         @default(1)
  scheduledFor DateTime?
  startTime    DateTime?
  endTime      DateTime?

  // Draft settings
  timePerPick Int @default(90) // Seconds
  totalRounds Int @default(6)

  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Relations
  picks       DraftPick[]
  draftOrder  DraftOrder[]
  draftGrades DraftGrade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("drafts")
}

model DraftOrder {
  id       String @id @default(cuid())
  position Int

  draftId String
  draft   Draft  @relation(fields: [draftId], references: [id], onDelete: Cascade)
  teamId  String

  @@unique([draftId, position])
  @@map("draft_orders")
}

model DraftPick {
  id         String   @id @default(cuid())
  pickNumber Int
  round      Int
  amount     Float? // For auction drafts
  pickedAt   DateTime @default(now())

  // Auction specific
  nominatedBy String? // Team that nominated (auction)
  isAutoPick  Boolean @default(false)

  draftId  String
  draft    Draft  @relation(fields: [draftId], references: [id], onDelete: Cascade)
  teamId   String
  team     Team   @relation(fields: [teamId], references: [id])
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  // Decision reasoning (Phase 6A — feeds Decision Graph)
  pickTag        String?  @db.VarChar(20)  // STEAL, REACH, PLAN, FALLBACK, VALUE, PANIC
  boardRankAtPick Int?                      // Where this player was on user's board at pick time
  boardId        String?                    // Which board was active during draft

  // Relations
  draftValueTracker DraftValueTracker?

  @@unique([draftId, pickNumber])
  @@map("draft_picks")
}

// ============ MATCHUPS (H2H) ============

model Matchup {
  id           String  @id @default(cuid())
  week         Int
  homeScore    Float   @default(0)
  awayScore    Float   @default(0)
  isPlayoff        Boolean @default(false)
  playoffRound     Int? // 1 = quarterfinals, 2 = semifinals, 3 = finals, etc.
  playoffMatchType String? // QUARTERFINAL, SEMIFINAL, FINAL, THIRD_PLACE, FIFTH_PLACE
  isComplete       Boolean @default(false)

  leagueId      String
  league        League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  tournamentId  String?
  tournament    Tournament?  @relation(fields: [tournamentId], references: [id])
  fantasyWeekId String?
  fantasyWeek   FantasyWeek? @relation(fields: [fantasyWeekId], references: [id])
  homeTeamId    String
  homeTeam      Team         @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeamId    String
  awayTeam      Team         @relation("AwayTeam", fields: [awayTeamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("matchups")
}

// ============ PICKS (One-and-Done) ============

model Pick {
  id         String  @id @default(cuid())
  tier       Int     @default(1)
  multiplier Float   @default(1.0)
  points     Float   @default(0)
  locked     Boolean @default(false) // Locked once tournament starts

  userId       String
  user         User       @relation(fields: [userId], references: [id])
  leagueId     String
  league       League     @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  playerId     String
  player       Player     @relation(fields: [playerId], references: [id])
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, leagueId, tournamentId])
  @@map("picks")
}

// ============ TRADES ============

model Trade {
  id      String      @id @default(cuid())
  status  TradeStatus @default(PENDING)
  message String?

  // Review period
  proposedAt  DateTime  @default(now())
  expiresAt   DateTime? // Auto-reject after this time
  reviewUntil DateTime? // League review period ends

  initiatorId    String
  initiator      User   @relation("TradeInitiator", fields: [initiatorId], references: [id])
  receiverId     String
  receiver       User   @relation("TradeReceiver", fields: [receiverId], references: [id])
  senderTeamId   String
  senderTeam     Team   @relation("TradeSender", fields: [senderTeamId], references: [id])
  receiverTeamId String
  receiverTeam   Team   @relation("TradeReceiver", fields: [receiverTeamId], references: [id])
  leagueId       String
  league         League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  // Store player IDs as JSON arrays
  senderPlayers   Json @default("[]")
  receiverPlayers Json @default("[]")

  // Optional: draft pick trades
  senderPicks   Json @default("[]")
  receiverPicks Json @default("[]")

  // Trade veto voting
  vetoVotes Json @default("[]")

  // Decision reasoning (Phase 6A — feeds Decision Graph)
  proposerReasoning  String?  @db.VarChar(280)
  responderReasoning String?  @db.VarChar(280)

  // Draft dollar trading
  senderDollars   Json @default("{}") // { current: 0, next: 0 }
  receiverDollars Json @default("{}") // { current: 0, next: 0 }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("trades")
}

// ============ MESSAGES ============

model Message {
  id          String   @id @default(cuid())
  content     String
  messageType String   @default("CHAT") // CHAT, SYSTEM, TRADE, DRAFT
  createdAt   DateTime @default(now())

  userId   String
  user     User   @relation(fields: [userId], references: [id])
  leagueId String
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@index([leagueId, createdAt])
  @@map("messages")
}

// ============ NOTIFICATIONS ============

model Notification {
  id        String   @id @default(cuid())
  type      String // TRADE_OFFER, DRAFT_PICK, LEAGUE_INVITE, SCORE_UPDATE, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  actionUrl String? // Deep link to relevant page
  data      Json?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId, read])
  @@map("notifications")
}

// ============ SPORT & SEASON ABSTRACTION (Phase 1) ============

model Sport {
  id       String  @id @default(cuid())
  slug     String  @unique // "golf", "nfl", "nba"
  name     String
  isActive Boolean @default(true)
  config   Json    @default("{}") // seasonType, weekDefinition, statCategories, rosterPositions, defaultScoringPresets

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seasons        Season[]
  scoringSystems ScoringSystem[]
  leagues        League[]        @relation("LeagueSport")
  positions      Position[]
  playerTags     PlayerTag[]
  sportProfiles  SportPlayerProfile[]
  players        Player[]        @relation("PlayerSport")

  // Manager Analytics relations
  managerProfiles        ManagerProfile[]        @relation("ManagerProfileSport")
  h2hRecords             HeadToHeadRecord[]      @relation("H2HSport")
  achievements           Achievement[]           @relation("AchievementSport")
  managerSeasonSummaries ManagerSeasonSummary[]  @relation("ManagerSeasonSummarySport")
  mockDraftResults       MockDraftResult[]       @relation("MockDraftSport")

  @@map("sports")
}

model Season {
  id        String   @id @default(cuid())
  sportId   String
  sport     Sport    @relation(fields: [sportId], references: [id])
  name      String // "2025-26 PGA Tour Season"
  year      Int // Primary year (e.g. 2025 for 2025-26 season)
  slug      String // "2025-26"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  weeks          FantasyWeek[]
  leagueSeasons  LeagueSeason[]
  playerStats    PlayerSeasonStats[]
  scoringRecords FantasyScore[]
  adpEntries     ADPEntry[]
  consistency    PlayerConsistency[]
  ownershipRates OwnershipRate[]
  tagAssignments PlayerTagAssignment[]
  sportProfiles  SportPlayerProfile[]
  managerSeasonSummaries ManagerSeasonSummary[]

  @@unique([sportId, slug])
  @@map("seasons")
}

model FantasyWeek {
  id         String            @id @default(cuid())
  seasonId   String
  season     Season            @relation(fields: [seasonId], references: [id])
  weekNumber Int
  name       String // "The Players Championship" or "Week 12"
  startDate  DateTime
  endDate    DateTime
  status     FantasyWeekStatus @default(UPCOMING)

  // Sport-specific link (nullable — golf links to tournament, NFL links to game week)
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  matchups           Matchup[]
  fantasyScores      FantasyScore[]
  weeklyResults      WeeklyTeamResult[]
  lineupSnapshots    LineupSnapshot[]
  rosterTransactions RosterTransaction[]
  ownershipRates     OwnershipRate[]
  slotAssignments    RosterSlotAssignment[]

  @@unique([seasonId, weekNumber])
  @@map("fantasy_weeks")
}

model ScoringSystem {
  id        String  @id @default(cuid())
  sportId   String
  sport     Sport   @relation(fields: [sportId], references: [id])
  name      String // "Standard", "DraftKings", "Custom League X"
  slug      String // "standard", "draftkings"
  isDefault Boolean @default(false)
  isSystem  Boolean @default(true) // System presets vs user-created
  rules     Json // Full scoring config (positionPoints, holeScoring, bonuses, strokesGained, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leagues           League[]            @relation("LeagueScoring")
  fantasyScores     FantasyScore[]
  playerConsistency PlayerConsistency[]
  rosterSlots       RosterSlotDefinition[]

  @@unique([sportId, slug])
  @@map("scoring_systems")
}

// ============ FANTASY PERFORMANCE TRACKING (Phase 2) ============

model FantasyScore {
  id              String        @id @default(cuid())
  fantasyWeekId   String
  fantasyWeek     FantasyWeek   @relation(fields: [fantasyWeekId], references: [id])
  scoringSystemId String
  scoringSystem   ScoringSystem @relation(fields: [scoringSystemId], references: [id])
  seasonId        String
  season          Season        @relation(fields: [seasonId], references: [id])

  // Player reference — links to Player model
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  totalPoints Float
  breakdown   Json  @default("{}") // { position, holes, bonuses, strokesGained }
  rank        Int? // Rank among all players that week for this scoring system

  // Link to sport-specific performance (golf: Performance, future NFL: GamePerformance)
  performanceId String? // FK to Performance (golf) — nullable for sport flexibility

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fantasyWeekId, scoringSystemId, playerId])
  @@index([playerId, fantasyWeekId])
  @@index([fantasyWeekId, totalPoints])
  @@index([seasonId, playerId])
  @@map("fantasy_scores")
}

model LeagueSeason {
  id       String             @id @default(cuid())
  leagueId String
  league   League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  seasonId String
  season   Season             @relation(fields: [seasonId], references: [id])
  status   LeagueSeasonStatus @default(ACTIVE)

  championTeamId String?
  finalStandings Json? // [{ teamId, rank, totalPoints }]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teamSeasons        TeamSeason[]
  weeklyResults      WeeklyTeamResult[]
  lineupSnapshots    LineupSnapshot[]
  rosterTransactions RosterTransaction[]
  draftValueTrackers DraftValueTracker[]
  teamBudgets        TeamBudget[]

  // Draft dollar tracking
  draftDollarAccounts      DraftDollarAccount[]
  draftDollarTransactions  DraftDollarTransaction[]

  @@unique([leagueId, seasonId])
  @@map("league_seasons")
}

model TeamSeason {
  id             String       @id @default(cuid())
  leagueSeasonId String
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Team name at this point in time (tracks renames across seasons)
  teamName String?

  // Aggregated season stats
  totalPoints Float   @default(0)
  wins        Int     @default(0)
  losses      Int     @default(0)
  ties        Int     @default(0)
  finalRank   Int?
  isChampion  Boolean @default(false)

  // Extremes
  bestWeekPoints  Float?
  worstWeekPoints Float?
  maxWinStreak    Int    @default(0)

  // Playoff tracking
  madePlayoffs   Boolean @default(false)
  playoffSeed    Int?
  playoffWins    Int     @default(0)
  playoffLosses  Int     @default(0)
  playoffByes    Int     @default(0)

  // Flexible stats (avgPointsPerWeek, consistency, etc.)
  stats Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  weeklyResults WeeklyTeamResult[]

  @@unique([leagueSeasonId, teamId])
  @@map("team_seasons")
}

model WeeklyTeamResult {
  id             String       @id @default(cuid())
  leagueSeasonId String
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  teamSeasonId   String
  teamSeason     TeamSeason   @relation(fields: [teamSeasonId], references: [id], onDelete: Cascade)
  fantasyWeekId  String
  fantasyWeek    FantasyWeek  @relation(fields: [fantasyWeekId], references: [id])
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id])
  weekNumber     Int

  // Scoring
  totalPoints  Float @default(0)
  playerScores Json  @default("[]") // [{ playerId, playerName, points, breakdown }]

  // H2H results (nullable for non-H2H formats)
  opponentTeamId String?
  opponentPoints Float?
  result         MatchResult?

  // Analytics
  optimalPoints     Float? // Best possible lineup
  pointsLeftOnBench Float? // optimalPoints - totalPoints
  weekRank          Int? // Rank among all teams in league that week

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leagueSeasonId, teamId, fantasyWeekId])
  @@index([fantasyWeekId])
  @@map("weekly_team_results")
}

model LineupSnapshot {
  id             String       @id @default(cuid())
  leagueSeasonId String
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  fantasyWeekId  String
  fantasyWeek    FantasyWeek  @relation(fields: [fantasyWeekId], references: [id])
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id])

  // Lineup at lock time
  lineup        Json   @default("[]") // [{ playerId, playerName, position: "ACTIVE"|"BENCH", slot }]
  activePoints  Float? // Points from active players
  benchPoints   Float? // Points from bench players
  optimalPoints Float? // Best possible arrangement

  // Decision reasoning (Phase 6A — feeds Decision Graph)
  decisionNotes Json?  // { "benchedPlayers": [{ "playerId": "x", "reason": "matchup" }], "startedPlayers": [...] }

  lockedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  @@unique([leagueSeasonId, fantasyWeekId, teamId])
  @@map("lineup_snapshots")
}

model RosterTransaction {
  id             String        @id @default(cuid())
  leagueSeasonId String?
  leagueSeason   LeagueSeason? @relation(fields: [leagueSeasonId], references: [id])
  fantasyWeekId  String?
  fantasyWeek    FantasyWeek?  @relation(fields: [fantasyWeekId], references: [id])
  teamId         String
  team           Team          @relation(fields: [teamId], references: [id])

  type TransactionType

  // Player involved
  playerId   String
  player     Player @relation(fields: [playerId], references: [id])
  playerName String // Denormalized for easy display

  // For trades — the other side
  otherTeamId     String?
  otherPlayerId   String?
  otherPlayerName String?

  // Draft-specific
  draftRound      Int?
  draftPickNumber Int?
  auctionAmount   Float?

  // Waiver-specific
  waiverBid      Float?
  waiverPriority Int?

  // Trade-specific
  tradeId String?

  // Computed after the fact
  fantasyPointsGenerated Float? // Total fantasy points this player scored after acquisition

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([playerId])
  @@index([leagueSeasonId, type])
  @@index([teamId])
  @@index([timestamp])
  @@map("roster_transactions")
}

// ============ ANALYTICS (Phase 3) ============

model PlayerSeasonStats {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  // Universal counting stats
  events   Int   @default(0)
  wins     Int   @default(0)
  top5s    Int   @default(0)
  top10s   Int   @default(0)
  cutsMade Int   @default(0)
  earnings Float @default(0)

  // Fantasy points by scoring system: { "standard": 245.5, "draftkings": 312.0 }
  fantasyPoints    Json @default("{}")
  avgFantasyPoints Json @default("{}")

  // Sport-specific stats (golf: SG breakdown; NFL: passing/rushing/receiving)
  stats Json @default("{}")

  // Rankings: { owgr, fedex, fantasyRank: { standard: 15, draftkings: 22 } }
  rankings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, seasonId])
  @@index([seasonId])
  @@map("player_season_stats")
}

model ADPEntry {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  adp          Float // Average draft position
  minPick      Int? // Earliest pick
  maxPick      Int? // Latest pick
  timesDrafted Int   @default(0)

  // Computed after season
  actualFantasyRank Int?
  valueOverAdp      Float? // positive = drafted later than actual rank (steal)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, seasonId])
  @@index([seasonId, adp])
  @@map("adp_entries")
}

model PlayerConsistency {
  id              String        @id @default(cuid())
  playerId        String
  player          Player        @relation(fields: [playerId], references: [id])
  seasonId        String
  season          Season        @relation(fields: [seasonId], references: [id])
  scoringSystemId String
  scoringSystem   ScoringSystem @relation(fields: [scoringSystemId], references: [id])

  // Central tendency
  avgPoints    Float @default(0)
  medianPoints Float @default(0)

  // Volatility
  stdDev           Float @default(0)
  coeffOfVariation Float @default(0) // stdDev / avgPoints

  // Percentiles
  floorPoints   Float @default(0) // 10th percentile
  ceilingPoints Float @default(0) // 90th percentile

  // Boom/bust rates
  boomRate Float @default(0) // % of weeks above 1.5x avg
  bustRate Float @default(0) // % of weeks below 0.5x avg

  // Raw data for re-computation
  weeklyScores Json @default("[]") // [{ weekId, weekNumber, points }]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, seasonId, scoringSystemId])
  @@index([seasonId, scoringSystemId])
  @@map("player_consistency")
}

model OwnershipRate {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  // null fantasyWeekId = season-level aggregate
  fantasyWeekId String?
  fantasyWeek   FantasyWeek? @relation(fields: [fantasyWeekId], references: [id])

  ownershipPct    Float  @default(0) // % of leagues that roster this player
  startPct        Float  @default(0) // % of owners who start this player
  previousWeekPct Float? // For week-over-week trending

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, seasonId, fantasyWeekId])
  @@index([seasonId, fantasyWeekId])
  @@map("ownership_rates")
}

model DraftValueTracker {
  id             String       @id @default(cuid())
  draftPickId    String       @unique
  draftPick      DraftPick    @relation(fields: [draftPickId], references: [id])
  playerId       String
  player         Player       @relation(fields: [playerId], references: [id])
  leagueSeasonId String
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id])

  pickNumber    Int
  round         Int
  auctionAmount Float?

  // Computed after season (or rolling)
  totalFantasyPoints   Float?
  fantasyRank          Int? // Rank among all rostered players
  valueOverReplacement Float? // Points above last-round replacement
  valueVsAdp           Float? // Actual rank vs ADP rank

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leagueSeasonId])
  @@index([playerId])
  @@map("draft_value_trackers")
}

// ============ ENUMS ============

enum LeagueFormat {
  FULL_LEAGUE
  HEAD_TO_HEAD
  ROTO
  SURVIVOR
  ONE_AND_DONE
}

enum DraftType {
  SNAKE
  AUCTION
  NONE
}

enum LeagueStatus {
  DRAFT_PENDING
  DRAFTING
  ACTIVE
  COMPLETED
}

enum DraftStatus {
  SCHEDULED
  IN_PROGRESS
  PAUSED
  COMPLETED
}

enum TournamentStatus {
  UPCOMING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TournamentFormat {
  STROKE
  MATCH
  TEAM
  STABLEFORD
  MODIFIED_STABLEFORD
}

enum TradeStatus {
  PENDING
  ACCEPTED
  IN_REVIEW
  REJECTED
  CANCELLED
  VETOED
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum FantasyWeekStatus {
  UPCOMING
  LOCKED
  IN_PROGRESS
  COMPLETED
}

enum LeagueSeasonStatus {
  ACTIVE
  PLAYOFFS
  COMPLETED
}

enum MatchResult {
  WIN
  LOSS
  TIE
}

enum TransactionType {
  DRAFT_PICK
  WAIVER_CLAIM
  FREE_AGENT_ADD
  FREE_AGENT_DROP
  TRADE_ACQUIRED
  TRADE_SENT
  COMMISSIONER_ADD
  COMMISSIONER_DROP
}

enum TagCategory {
  STATUS
  SKILL
  HEALTH
  CONTRACT
  CUSTOM
}

// ============ UNIVERSAL PLAYER PROFILE LAYER ============

model Position {
  id        String @id @default(cuid())
  sportId   String
  sport     Sport  @relation(fields: [sportId], references: [id])
  abbr      String // "QB", "RB", "G" (golfer)
  name      String // "Quarterback", "Running Back", "Golfer"
  sortOrder Int    @default(0)
  config    Json   @default("{}") // Sport-specific position config

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  playerPositions      PlayerPosition[]
  rosterSlotEligibility RosterSlotEligibility[]

  @@unique([sportId, abbr])
  @@map("positions")
}

model PlayerPosition {
  id         String  @id @default(cuid())
  playerId   String
  player     Player  @relation(fields: [playerId], references: [id])
  positionId String
  position   Position @relation(fields: [positionId], references: [id])
  isPrimary  Boolean @default(true)
  source     String? // "datagolf", "espn", "manual"

  createdAt DateTime @default(now())

  @@unique([playerId, positionId])
  @@index([positionId])
  @@map("player_positions")
}

model RosterSlotDefinition {
  id              String  @id @default(cuid())
  // Either league-level or scoring-system-level (one must be set)
  scoringSystemId String?
  scoringSystem   ScoringSystem? @relation(fields: [scoringSystemId], references: [id])
  leagueId        String?
  league          League? @relation("LeagueRosterSlots", fields: [leagueId], references: [id], onDelete: Cascade)

  slotKey     String // "QB1", "RB1", "RB2", "FLEX1", "BN1", "BN2"
  displayName String // "Quarterback", "Running Back", "Flex", "Bench"
  slotType    String // "STARTER", "BENCH", "IR"
  sortOrder   Int    @default(0)
  maxPlayers  Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  eligibility     RosterSlotEligibility[]
  slotAssignments RosterSlotAssignment[]

  @@unique([scoringSystemId, slotKey])
  @@unique([leagueId, slotKey])
  @@map("roster_slot_definitions")
}

model RosterSlotEligibility {
  id                     String               @id @default(cuid())
  rosterSlotDefinitionId String
  rosterSlotDefinition   RosterSlotDefinition @relation(fields: [rosterSlotDefinitionId], references: [id], onDelete: Cascade)
  positionId             String
  position               Position             @relation(fields: [positionId], references: [id])

  @@unique([rosterSlotDefinitionId, positionId])
  @@map("roster_slot_eligibility")
}

model RosterSlotAssignment {
  id                     String               @id @default(cuid())
  rosterSlotDefinitionId String
  rosterSlotDefinition   RosterSlotDefinition @relation(fields: [rosterSlotDefinitionId], references: [id])
  rosterEntryId          String
  rosterEntry            RosterEntry          @relation(fields: [rosterEntryId], references: [id])
  fantasyWeekId          String
  fantasyWeek            FantasyWeek          @relation(fields: [fantasyWeekId], references: [id])

  createdAt DateTime @default(now())

  @@unique([rosterSlotDefinitionId, fantasyWeekId, rosterEntryId])
  @@index([rosterEntryId, fantasyWeekId])
  @@map("roster_slot_assignments")
}

model PlayerTag {
  id       String      @id @default(cuid())
  sportId  String
  sport    Sport       @relation(fields: [sportId], references: [id])
  slug     String
  name     String
  category TagCategory
  color    String?     // Hex color for UI
  icon     String?     // Icon name or emoji

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignments PlayerTagAssignment[]

  @@unique([sportId, slug])
  @@map("player_tags")
}

model PlayerTagAssignment {
  id        String    @id @default(cuid())
  playerId  String
  player    Player    @relation(fields: [playerId], references: [id])
  tagId     String
  tag       PlayerTag @relation(fields: [tagId], references: [id])
  seasonId  String?
  season    Season?   @relation(fields: [seasonId], references: [id])
  value     String?   // Optional value (e.g., contract amount, injury type)
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@unique([playerId, tagId, seasonId])
  @@index([tagId])
  @@index([seasonId])
  @@map("player_tag_assignments")
}

model TeamBudget {
  id              String       @id @default(cuid())
  teamId          String
  team            Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  leagueSeasonId  String
  leagueSeason    LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)

  totalBudget     Float   @default(200)
  spent           Float   @default(0)
  remaining       Float   @default(200)
  spentByPosition Json    @default("{}") // { "QB": 45, "RB": 80, "WR": 60, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, leagueSeasonId])
  @@map("team_budgets")
}

model SportPlayerProfile {
  id       String  @id @default(cuid())
  playerId String
  player   Player  @relation(fields: [playerId], references: [id])
  sportId  String
  sport    Sport   @relation(fields: [sportId], references: [id])
  seasonId String
  season   Season  @relation(fields: [seasonId], references: [id])

  stats    Json @default("{}") // Sport-specific stats JSONB
  rankings Json @default("{}") // Sport-specific rankings JSONB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, sportId, seasonId])
  @@index([sportId, seasonId])
  @@map("sport_player_profiles")
}

// ============ MANAGER ANALYTICS & ACHIEVEMENTS ============

model ManagerProfile {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id])

  // Nullable = cross-sport aggregate
  sportId String?
  sport   Sport?  @relation("ManagerProfileSport", fields: [sportId], references: [id])

  totalLeagues    Int   @default(0)
  totalSeasons    Int   @default(0)
  championships   Int   @default(0)
  wins            Int   @default(0)
  losses          Int   @default(0)
  ties            Int   @default(0)
  winPct          Float @default(0)
  avgFinish       Float @default(0)
  bestFinish      Int?
  totalPoints     Float @default(0)
  auctionROI      Float? // avg points/dollar across auction drafts
  draftEfficiency Float? // avg valueVsAdp

  // Flexible stats: { streaks, perfectLineups, etc. }
  stats Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sportId])
  @@index([userId])
  @@map("manager_profiles")
}

model HeadToHeadRecord {
  id             String  @id @default(cuid())
  userId         String
  user           User    @relation("H2HUser", fields: [userId], references: [id])
  opponentUserId String
  opponent       User    @relation("H2HOpponent", fields: [opponentUserId], references: [id])

  // Nullable = all sports / all formats
  sportId      String?
  sport        Sport?        @relation("H2HSport", fields: [sportId], references: [id])
  leagueFormat LeagueFormat?

  wins           Int   @default(0)
  losses         Int   @default(0)
  ties           Int   @default(0)
  pointsFor      Float @default(0)
  pointsAgainst  Float @default(0)
  matchupsPlayed Int   @default(0)
  lastMatchupAt  DateTime?

  // { currentStreak, longestStreak, avgMargin }
  stats Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, opponentUserId, sportId, leagueFormat])
  @@index([userId])
  @@index([opponentUserId])
  @@map("head_to_head_records")
}

model Achievement {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String
  sportId     String?
  sport       Sport?  @relation("AchievementSport", fields: [sportId], references: [id])

  tier     AchievementTier
  icon     String? // emoji or icon name
  category AchievementCategory
  isHidden Boolean @default(false)

  // { type: "championships", threshold: 1 } — for automated checking
  criteria Json @default("{}")

  createdAt DateTime @default(now())

  // Relations
  unlocks AchievementUnlock[]

  @@map("achievements")
}

model AchievementUnlock {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())

  // { leagueId, seasonId, details }
  context Json?

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("achievement_unlocks")
}

model ManagerSeasonSummary {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  sportId  String
  sport    Sport  @relation("ManagerSeasonSummarySport", fields: [sportId], references: [id])
  seasonId String
  season   Season @relation(fields: [seasonId], references: [id])

  leaguesPlayed Int   @default(0)
  championships Int   @default(0)
  totalPoints   Float @default(0)
  wins          Int   @default(0)
  losses        Int   @default(0)
  ties          Int   @default(0)
  avgFinish     Float @default(0)
  bestFinish    Int?

  // { "HEAD_TO_HEAD": { wins, losses, avgFinish }, "FULL_LEAGUE": { ... } }
  byFormat Json @default("{}")

  // { snakeAvgValue, auctionROI, bestPick, worstPick }
  draftStats Json @default("{}")

  // Flexible overflow
  stats Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sportId, seasonId])
  @@index([userId])
  @@index([seasonId])
  @@map("manager_season_summaries")
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum AchievementCategory {
  SEASON
  DRAFT
  LINEUP
  SOCIAL
  MILESTONE
}

enum WaiverClaimStatus {
  PENDING
  WON
  LOST
  CANCELLED
  INVALID
}

// ============ WAIVER CLAIMS ============

model WaiverClaim {
  id       String            @id @default(cuid())
  leagueId String
  league   League            @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  teamId   String
  team     Team              @relation(fields: [teamId], references: [id])
  userId   String
  playerId String
  player   Player            @relation(fields: [playerId], references: [id])

  // Optional: player to drop if roster is full
  dropPlayerId String?

  bidAmount Float   @default(0)
  priority  Int     @default(0) // User's ordering of their own claims

  status      WaiverClaimStatus @default(PENDING)
  processedAt DateTime?
  notes       String?           // "Outbid by Team X", "Insufficient budget", etc.

  // Decision reasoning (Phase 6A — feeds Decision Graph)
  reasoning   String?           @db.VarChar(280)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leagueId, status])
  @@index([teamId, status])
  @@index([playerId])
  @@map("waiver_claims")
}

// ============ DRAFT GRADING ============

model DraftGrade {
  id             String  @id @default(cuid())
  draftId        String
  draft          Draft   @relation(fields: [draftId], references: [id], onDelete: Cascade)
  teamId         String
  team           Team    @relation(fields: [teamId], references: [id])

  overallGrade   String            // "A+", "A", "A-", "B+", ... "F"
  overallScore   Float             // 0-100
  positionGrades Json @default("{}") // { "G": { grade, score, picks }, "QB": { ... } }
  pickGrades     Json @default("[]") // [{ pickNumber, round, playerId, playerName, grade, score, adpDiff }]

  totalValue     Float  @default(0)
  bestPick       Json?             // { playerId, playerName, pickNumber, score }
  worstPick      Json?
  sleepers       Json @default("[]")
  reaches        Json @default("[]")

  sportId        String?
  algorithm      String @default("v1")
  gradedAt       DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([draftId, teamId])
  @@map("draft_grades")
}

model MockDraftResult {
  id           String  @id @default(cuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id])

  sportId      String?
  sport        Sport?  @relation("MockDraftSport", fields: [sportId], references: [id])
  draftType    String            // "snake" or "auction"
  teamCount    Int
  rosterSize   Int
  userPosition Int?              // draft slot (snake)
  dataSource   String @default("api") // "api" or "mock"

  picks        Json @default("[]")    // ALL picks
  userPicks    Json @default("[]")    // User's picks only
  teamNames    Json @default("[]")    // ["Your Team", "Eagle Eyes", ...]

  overallGrade   String?
  overallScore   Float?
  positionGrades Json @default("{}")
  pickGrades     Json @default("[]")
  bestPick       Json?
  worstPick      Json?

  completedAt  DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId, completedAt])
  @@map("mock_draft_results")
}

// ============ PUSH NOTIFICATIONS ============

model PushToken {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      PushTokenType
  token     String
  deviceId  String?
  userAgent String?
  endpoint  String?       // Web Push subscription endpoint
  p256dh    String?       // Web Push encryption key
  auth      String?       // Web Push auth secret
  isActive  Boolean       @default(true)
  lastUsed  DateTime      @default(now())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([userId, token])
  @@index([userId, isActive])
  @@map("push_tokens")
}

enum PushTokenType {
  WEB_PUSH
  APNS
  FCM
}

// ============ USER PREDICTIONS (Phase 2) ============

model Prediction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  sport          String // 'golf', 'nfl', 'nba', 'mlb'
  predictionType String // 'performance_call', 'player_benchmark', 'weekly_winner', 'bold_call'
  category       String // 'weekly', 'season_long', 'tournament', 'draft'

  // Context
  eventId         String? // tournament ID, NFL week, matchup ID
  subjectPlayerId String? // player this prediction is about
  leagueId        String? // optional league context
  league          League? @relation(fields: [leagueId], references: [id])

  // Prediction content
  predictionData Json // {action, benchmark_value, direction, confidence, reasoning}

  // Decision reasoning (Phase 6A — feeds Decision Graph)
  thesis          String?  @db.VarChar(280)  // Why the user believes this
  confidenceLevel Int?                        // 1-5 scale
  keyFactors      Json?                       // Array of factor tags

  // Outcome
  outcome       PredictionOutcome @default(PENDING)
  accuracyScore Float? // 0.0 to 1.0, allows partial credit

  isPublic Boolean @default(true)

  // Deadline enforcement
  locksAt    DateTime? // When this prediction locks (tee time, kickoff, etc.)
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, sport, outcome])
  @@index([eventId, predictionType])
  @@index([outcome])
  @@index([subjectPlayerId])
  @@map("predictions")
}

model UserReputation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])
  sport  String // 'golf', 'nfl', 'nba', 'mlb', 'all'

  totalPredictions   Int   @default(0)
  correctPredictions Int   @default(0)
  accuracyRate       Float @default(0)
  streakCurrent      Int   @default(0)
  streakBest         Int   @default(0)
  confidenceScore    Float @default(0) // Weighted accuracy factoring confidence
  percentileRank     Int? // 1-100
  tier               String @default("rookie") // 'rookie', 'contender', 'sharp', 'expert', 'elite'

  badges     Json @default("[]")
  weeklyRank Int?
  seasonRank Int?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([userId, sport])
  @@index([sport, tier])
  @@index([sport, accuracyRate])
  @@map("user_reputation")
}

enum PredictionOutcome {
  PENDING
  CORRECT
  INCORRECT
  PUSH
  VOIDED
}

// ============ LEAGUE HISTORY & MIGRATION (Phase 3) ============

enum ImportStatus {
  PENDING
  SCANNING
  MAPPING
  IMPORTING
  REVIEW
  COMPLETE
  FAILED
}

model LeagueImport {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  sourcePlatform  String       // 'sleeper', 'yahoo', 'espn', 'fantrax', 'mfl', 'manual_csv'
  sourceLeagueId  String?      // External league ID on source platform
  sourceLeagueName String?     // Name from source platform
  status          ImportStatus @default(PENDING)
  progressPct     Int          @default(0)
  seasonsFound    Int?
  seasonsImported Json         @default("[]") // Array of imported year numbers
  mappingData     Json         @default("{}") // Player/owner mapping state
  errorLog        Json         @default("[]") // Array of error entries
  rawData         Json?        // Cached raw API response

  // Link to Clutch league (created or matched during import)
  clutchLeagueId  String?
  clutchLeague    League?      @relation("LeagueImports", fields: [clutchLeagueId], references: [id])

  createdAt       DateTime     @default(now())
  completedAt     DateTime?

  // Relations
  historicalSeasons HistoricalSeason[]

  @@index([userId])
  @@index([sourcePlatform, status])
  @@map("league_imports")
}

model HistoricalSeason {
  id         String       @id @default(cuid())
  leagueId   String
  league     League       @relation("LeagueHistory", fields: [leagueId], references: [id], onDelete: Cascade)
  importId   String?
  import     LeagueImport? @relation(fields: [importId], references: [id])
  seasonYear Int

  // Team info
  teamName     String?
  ownerName    String?
  ownerUserId  String?      // Nullable until claimed by a Clutch user
  ownerUser    User?        @relation("HistoricalOwner", fields: [ownerUserId], references: [id])

  // Results
  finalStanding  Int?
  wins           Int      @default(0)
  losses         Int      @default(0)
  ties           Int      @default(0)
  pointsFor      Float    @default(0)
  pointsAgainst  Float    @default(0)
  playoffResult  String?  // 'champion', 'runner_up', 'semifinal', 'eliminated', 'missed'

  // Historical data (JSONB for flexibility across platforms)
  draftData      Json?    // Pick-by-pick draft history
  rosterData     Json?    // End-of-season roster
  weeklyScores   Json?    // Week-by-week scoring
  transactions   Json?    // Trades, adds, drops
  awards         Json?    // MVP, most points week, etc.
  settings       Json?    // League settings snapshot for that season

  createdAt      DateTime @default(now())

  @@unique([leagueId, seasonYear, ownerName])
  @@index([leagueId, seasonYear])
  @@index([ownerUserId])
  @@map("historical_seasons")
}

// ============ OWNER ALIASES (Commissioner name grouping) ============

model OwnerAlias {
  id            String   @id @default(cuid())
  leagueId      String
  league        League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  ownerName     String
  canonicalName String
  ownerUserId   String?
  ownerUser     User?    @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@unique([leagueId, ownerName])
  @@index([leagueId])
  @@map("owner_aliases")
}

// ============ DATA ARCHITECTURE (Phase 4) ============

// Layer 1 — Raw Provider Staging
model RawProviderData {
  id          String    @id @default(cuid())
  provider    String    // "datagolf", "espn", "pgatour", "owgr"
  dataType    String    // "player_list", "rankings", "skill_ratings", "field_updates", "live_scoring", "predictions", "projections", "tournament_stats", "schedule"
  eventRef    String?   // Provider's event ID (nullable for non-event data)
  payload     Json      // Full raw JSON response
  recordCount Int?
  ingestedAt  DateTime  @default(now())
  processedAt DateTime?

  @@index([provider, dataType, ingestedAt])
  @@index([provider, eventRef])
  @@map("raw_provider_data")
}

// Layer 3 — Clutch Computed Metrics
model ClutchScore {
  id             String      @id @default(cuid())
  playerId       String
  player         Player      @relation(fields: [playerId], references: [id])
  tournamentId   String?     // null = weekly snapshot, set = event-specific
  tournament     Tournament? @relation(fields: [tournamentId], references: [id])
  cpi            Float?      // Clutch Performance Index: -3.0 to +3.0
  courseFitScore Float?      // 0-100
  formScore      Float?      // 0-100
  pressureScore  Float?      // -2.0 to +2.0
  cpiComponents      Json?   // breakdown of CPI inputs
  formComponents     Json?   // breakdown of form inputs
  fitComponents      Json?   // player profile x course profile
  pressureComponents Json?   // pressure vs baseline breakdown
  formulaVersion String      // "v1.0"
  inputs         Json        @default("{}")  // full input snapshot for reproducibility
  computedAt     DateTime    @default(now())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([playerId, tournamentId, formulaVersion])
  @@index([playerId, computedAt(sort: Desc)])
  @@index([tournamentId])
  @@map("clutch_scores")
}

// Rosetta Stone — Event ID cross-reference
model ClutchEventIdMap {
  id              String      @id @default(cuid())
  sport           String      @default("golf")
  eventName       String
  datagolfEventId String?     @unique
  espnEventId     String?
  pgaTourEventId  String?
  owgrEventId     String?
  startDate       DateTime?
  endDate         DateTime?
  tournamentId    String?     @unique
  tournament      Tournament? @relation(fields: [tournamentId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([sport])
  @@map("clutch_event_id_map")
}

// Formula versioning audit log
model ClutchFormulaLog {
  id            String    @id @default(cuid())
  version       String    @unique // "v1.0"
  description   String
  parameters    Json      @default("{}")
  activatedAt   DateTime  @default(now())
  deactivatedAt DateTime?

  @@map("clutch_formula_log")
}

// ============ CLUTCH MANAGER RATING (Phase 5) ============

model ClutchManagerRating {
  id                   String   @id @default(cuid())
  userId               String   @unique @map("user_id")
  user                 User     @relation(fields: [userId], references: [id])
  overallRating        Float?   @map("overall_rating")
  accuracyComponent    Float?   @map("accuracy_component")
  consistencyComponent Float?   @map("consistency_component")
  volumeComponent      Float?   @map("volume_component")
  breadthComponent     Float?   @map("breadth_component")
  tier                 String   @default("developing")
  trend                String   @default("stable")
  totalGradedCalls     Int      @default(0) @map("total_graded_calls")
  computationInputs    Json     @default("{}") @map("computation_inputs")
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([tier])
  @@index([overallRating(sort: Desc)])
  @@map("clutch_manager_ratings")
}

// ============ OAUTH TOKENS ============

model UserOAuthToken {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     String    // "yahoo", "espn", etc.
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, provider])
  @@map("user_oauth_tokens")
}

// ============ DRAFT DOLLAR TRACKING ============

model DraftDollarAccount {
  id              String       @id @default(cuid())
  teamId          String
  leagueSeasonId  String
  currentBalance  Int          @default(200)
  nextYearBalance Int          @default(200)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  team         Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  leagueSeason LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)

  @@unique([teamId, leagueSeasonId])
  @@map("draft_dollar_accounts")
}

model DraftDollarTransaction {
  id              String    @id @default(cuid())
  leagueId        String
  leagueSeasonId  String
  fromTeamId      String?
  toTeamId        String?
  amount          Int
  yearType        String    // "current" | "next"
  category        String    // "trade" | "side_bet" | "commissioner_adjustment"
  description     String?
  tradeId         String?
  initiatedById   String
  createdAt       DateTime  @default(now())

  league       League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  leagueSeason LeagueSeason @relation(fields: [leagueSeasonId], references: [id])
  fromTeam     Team?        @relation("DollarFrom", fields: [fromTeamId], references: [id])
  toTeam       Team?        @relation("DollarTo", fields: [toTeamId], references: [id])

  @@index([leagueId, createdAt])
  @@map("draft_dollar_transactions")
}

// ============ NFL EXPANSION (Phase 7) ============

model NflTeam {
  id             String   @id @default(cuid())
  abbreviation   String   @unique // KC, BAL, SF, etc.
  name           String   // Kansas City Chiefs
  city           String   // Kansas City
  conference     String   // AFC, NFC
  division       String   // West, East, North, South
  logoUrl        String?
  primaryColor   String?  // hex
  secondaryColor String?  // hex

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  homeGames   NflGame[] @relation("NflHomeTeam")
  awayGames   NflGame[] @relation("NflAwayTeam")

  @@map("nfl_teams")
}

model NflGame {
  id            String   @id @default(cuid())
  externalId    String?  @unique // nflverse game_id: "2024_01_KC_BAL"
  season        Int      // 2024, 2025, 2026
  week          Int      // 1-18 regular, 19-22 playoffs
  gameType      String   @default("REG") // REG, WC, DIV, CON, SB

  kickoff       DateTime
  homeTeamId    String
  awayTeamId    String
  homeTeam      NflTeam  @relation("NflHomeTeam", fields: [homeTeamId], references: [id])
  awayTeam      NflTeam  @relation("NflAwayTeam", fields: [awayTeamId], references: [id])

  homeScore     Int?
  awayScore     Int?
  status        String   @default("UPCOMING") // UPCOMING, IN_PROGRESS, FINAL

  // Venue & conditions
  venue         String?
  surface       String?  // grass, fieldturf, etc.
  roof          String?  // outdoors, dome, retractable
  weather       Json?    // { temp, wind, humidity, condition }

  // Lines (frozen Wednesday noon ET)
  spreadLine    Float?   // Home team spread (negative = favored)
  totalLine     Float?   // Over/under
  homeMoneyline Int?     // e.g., -150
  awayMoneyline Int?     // e.g., +130

  // Source tracking
  sourceProvider      String?
  sourceIngestedAt    DateTime?
  clutchTransformedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  playerStats NflPlayerGame[]

  @@index([season, week])
  @@index([status])
  @@map("nfl_games")
}

model NflPlayerGame {
  id        String  @id @default(cuid())
  playerId  String
  player    Player  @relation(fields: [playerId], references: [id])
  gameId    String
  game      NflGame @relation(fields: [gameId], references: [id], onDelete: Cascade)
  teamAbbr  String  // Which team they played for that game

  // Passing
  passAttempts    Int?
  passCompletions Int?
  passYards       Int?
  passTds         Int?
  interceptions   Int?
  sacked          Int?
  sackYards       Int?
  passerRating    Float?

  // Rushing
  rushAttempts Int?
  rushYards    Int?
  rushTds      Int?
  fumbles      Int?
  fumblesLost  Int?

  // Receiving
  targets    Int?
  receptions Int?
  recYards   Int?
  recTds     Int?

  // Advanced (nflverse pre-computed)
  epa         Float? // Expected Points Added (total)
  cpoe        Float? // Completion % Over Expected (QBs)
  successRate Float? // % of plays with positive EPA

  // Usage
  snapCount    Int?
  snapPct      Float?
  targetShare  Float?
  rushShare     Float?

  // Defense/Special Teams
  sacks            Float?
  tacklesSolo      Int?
  tacklesAssist    Int?
  passesDefended   Int?
  fumblesForced    Int?
  fumblesRecovered Int?
  defInterceptions Int?
  defTds           Int?

  // 2-point conversions
  pass2pt    Int?
  rush2pt    Int?
  rec2pt     Int?

  // Special teams / return stats
  returnYards Int?
  returnTds   Int?

  // Kicking
  fgMade     Int?
  fgAttempts Int?
  fgPct      Float?
  fgMade0_19   Int? // FG made 0-19 yards
  fgMade20_29  Int? // FG made 20-29 yards
  fgMade30_39  Int? // FG made 30-39 yards
  fgMade40_49  Int? // FG made 40-49 yards
  fgMade50Plus Int? // FG made 50+ yards
  xpMade     Int?
  xpAttempts Int?

  // Team defense extras
  safeties        Int?
  blockedKicks    Int?
  pointsAllowed   Int? // Total points allowed (for DST scoring tiers)
  yardsAllowed    Int? // Total yards allowed (for DST scoring tiers)

  // Fantasy points (pre-computed for convenience)
  fantasyPtsStd  Float? // Standard scoring
  fantasyPtsPpr  Float? // PPR scoring
  fantasyPtsHalf Float? // Half-PPR scoring

  // Source tracking
  sourceProvider      String?
  sourceIngestedAt    DateTime?
  clutchTransformedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, gameId])
  @@index([gameId])
  @@index([playerId])
  @@index([teamAbbr])
  @@map("nfl_player_games")
}

// ============ NEWS ARTICLES ============

model NewsArticle {
  id              String    @id @default(cuid())
  externalId      String    @unique          // ESPN article ID — dedup key
  provider        String    @default("espn") // "espn", "nfl_rss", etc.
  sport           String    @default("nfl")  // "nfl", "golf", "nba"
  type            String                     // "news", "transaction", "injury", "analysis"
  headline        String
  description     String?
  url             String?                    // Link to original article
  imageUrl        String?                    // Header image from ESPN CDN
  byline          String?                    // Reporter name
  published       DateTime
  teamAbbrs       String[]  @default([])     // Matched NflTeam abbreviations
  playerIds       String[]  @default([])     // Matched Player cuid IDs
  category        String?                    // "breaking", "transaction", "injury", "analysis"
  priority        Int       @default(3)      // 1=breaking, 2=high, 3=normal
  createdAt       DateTime  @default(now())

  @@index([sport, published(sort: Desc)])
  @@index([category, published(sort: Desc)])
  @@map("news_articles")
}

// ============ PROVE IT — WEEKLY PROP LINES ============

model PropLine {
  id        String @id @default(cuid())
  sport     String // 'nfl', 'golf'
  season    Int
  week      Int    // NFL week number (1-18)

  // Subject — a player or a game
  playerId  String?
  player    Player?  @relation(fields: [playerId], references: [id])
  gameId    String?  // NflGame.id for game-level props
  teamAbbr  String?  // For display: "BUF", "PHI"

  // Prop details
  propType  String  // 'passing_yards', 'rushing_yards', 'receptions', 'receiving_yards', 'passing_tds', 'rushing_tds', 'game_total', 'game_spread'
  lineValue Float   // The O/U number (e.g., 264.5)
  category  String  // 'player_prop', 'game_prop'

  // Display
  description  String  // "Josh Allen passing yards"
  displayLine  String  // "O/U 264.5"

  // Generation metadata
  generatedFrom Json? // { method, seasonAvg, last3Avg, adjustment, sampleSize }

  // Lock + resolution
  locksAt     DateTime? // Kickoff time of the relevant game
  actualValue Float?    // After game: actual stat value
  result      String?   // 'over', 'under', 'push'
  resolvedAt  DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sport, season, week, playerId, propType])
  @@index([sport, season, week, isActive])
  @@index([locksAt])
  @@map("prop_lines")
}

// ============ WORKSPACE — DRAFT BOARDS ============

model DraftBoard {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  scoringFormat  String   @default("ppr")     // ppr, half_ppr, standard
  sport          String   @default("nfl")     // nfl, golf
  season         Int      @default(2026)
  boardType      String   @default("overall") // overall, qb, rb, wr, te
  isPublished    Boolean  @default(false)
  publishedAt    DateTime?
  leagueType     String?  @map("league_type")
  teamCount      Int?     @map("team_count")
  draftType      String?  @map("draft_type")
  rosterConfig   Json?    @map("roster_config")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  entries        DraftBoardEntry[]
  activities     BoardActivity[]
  cheatSheets    LabCheatSheet[]

  @@index([userId])
  @@index([userId, sport])
  @@map("clutch_draft_boards")
}

model DraftBoardEntry {
  id        String     @id @default(cuid())
  boardId   String
  board     DraftBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  playerId  String
  player    Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  rank         Int
  tier         Int?
  notes        String?    @db.Text
  tags         Json?
  reasonChips  Json?      @map("reason_chips")
  baselineRank Int?       @map("baseline_rank")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([boardId, playerId])
  @@index([boardId])
  @@index([boardId, rank])
  @@map("clutch_draft_board_entries")
}

model DraftBoardComparison {
  id              String   @id @default(cuid())
  userId          String
  draftId         String?
  mockDraftId     String?
  boardId         String
  sport           String
  comparisonData  Json
  createdAt       DateTime @default(now())

  @@index([userId])
  @@map("draft_board_comparisons")
}

// ============ WORKSPACE — CLUTCH PROJECTIONS (Pre-loaded Rankings) ============

model ClutchProjection {
  id             String   @id @default(cuid())
  sport          String   // nfl, golf
  scoringFormat  String   // ppr, half_ppr, standard (nfl); overall (golf)
  season         Int
  week           Int?     // null = season-long
  playerId       String
  player         Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  projectedPts   Float?
  adpRank        Int?
  clutchRank     Int
  tradeValue     Int?
  position       String?  // QB, RB, WR, TE, K, DEF (cached for filtering)
  metadata       Json?    // raw inputs for transparency
  computedAt     DateTime @default(now())

  @@unique([sport, scoringFormat, season, week, playerId])
  @@index([sport, scoringFormat, season, clutchRank])
  @@map("clutch_projections")
}

// ============ WORKSPACE — WATCH LIST ============

model WatchListEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerId  String
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  sport     String
  note      String?  @db.VarChar(280)
  createdAt DateTime @default(now())

  @@unique([userId, playerId])
  @@index([userId, sport])
  @@map("clutch_watch_list")
}

// ============ WORKSPACE — BOARD ACTIVITY LOG (Decision Journal) ============

model BoardActivity {
  id        String     @id @default(cuid())
  boardId   String
  board     DraftBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerId  String?
  action    String     // board_created, player_moved, player_tagged, note_added, player_added, player_removed
  details   Json?      // { playerName, from, to, delta, tags, reasonChips, note }
  createdAt DateTime   @default(now())

  @@index([boardId, createdAt])
  @@index([userId, createdAt])
  @@map("clutch_board_activities")
}

// ============ THE LAB — CAPTURES ============

model LabCapture {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  content     String
  sourceType  String?  @map("source_type")
  sourceName  String?  @map("source_name")
  sentiment   String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Outcome linking (Phase 6A — feeds Decision Graph)
  outcomeLinked    Boolean   @default(false)
  outcomeData      Json?
  outcomeLinkedAt  DateTime?

  user    User              @relation(fields: [userId], references: [id])
  players LabCapturePlayer[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("clutch_lab_captures")
}

model LabCapturePlayer {
  id           String  @id @default(uuid())
  captureId    String  @map("capture_id")
  playerId     String  @map("player_id")
  autoDetected Boolean @default(false) @map("auto_detected")
  confirmed    Boolean @default(true)

  capture LabCapture @relation(fields: [captureId], references: [id], onDelete: Cascade)
  player  Player     @relation(fields: [playerId], references: [id])

  @@index([captureId])
  @@index([playerId])
  @@map("clutch_lab_capture_players")
}

// ============ THE LAB — INSIGHT CACHE ============

model LabInsightCache {
  userId      String    @id @map("user_id")
  insightText String    @map("insight_text")
  insightType String    @map("insight_type")
  generatedAt DateTime  @default(now()) @map("generated_at")
  dismissedAt DateTime? @map("dismissed_at")

  user User @relation(fields: [userId], references: [id])

  @@map("clutch_lab_insights_cache")
}

// ============ THE LAB — CHEAT SHEETS ============

model LabCheatSheet {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  boardId         String    @map("board_id")
  title           String
  contentJson     Json      @map("content_json")
  formatSettings  Json?     @map("format_settings")
  generatedAt     DateTime  @default(now()) @map("generated_at")
  reviewedAt      DateTime? @map("reviewed_at")
  publishedAt     DateTime? @map("published_at")

  user  User       @relation(fields: [userId], references: [id])
  board DraftBoard @relation(fields: [boardId], references: [id])

  @@index([userId])
  @@index([boardId])
  @@map("clutch_lab_cheatsheets")
}

// ============ OPINION TIMELINE (Phase 6A-5) ============

model PlayerOpinionEvent {
  id            String   @id @default(cuid())
  userId        String
  playerId      String
  sport         String
  eventType     String   // CAPTURE, WATCH_ADD, WATCH_REMOVE, BOARD_ADD, BOARD_MOVE, BOARD_TAG, etc.
  eventData     Json
  sentiment     String?  // positive, negative, neutral, mixed
  sourceId      String?
  sourceType    String?
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id])

  @@index([userId, playerId, createdAt])
  @@index([userId, sport, createdAt])
}

// ============ USER INTELLIGENCE PROFILE (Phase 6B) ============

model UserIntelligenceProfile {
  id              String   @id @default(cuid())
  userId          String
  sport           String
  profileData     Json
  dataConfidence  String   // LOW, MEDIUM, HIGH
  generatedAt     DateTime @default(now())
  expiresAt       DateTime

  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, sport])
  @@index([userId])
}

// ============ AI INSIGHTS + REPORTS (Phase 6C) ============

model AiInsight {
  id              String    @id @default(cuid())
  userId          String
  sport           String?
  insightType     String
  title           String
  body            String    @db.Text
  metadata        Json?
  priority        Int       @default(5)
  status          String    @default("active")
  expiresAt       DateTime?
  generatedAt     DateTime  @default(now())
  dismissedAt     DateTime?
  tokenCount      Int?

  user            User      @relation(fields: [userId], references: [id])

  @@index([userId, status, priority])
  @@index([userId, insightType])
}

model AiReport {
  id              String    @id @default(cuid())
  userId          String?
  sport           String
  reportType      String
  subjectId       String?
  contentJson     Json
  generatedAt     DateTime  @default(now())
  expiresAt       DateTime
  tokenCount      Int?

  user            User?     @relation(fields: [userId], references: [id])

  @@index([sport, reportType, subjectId])
  @@index([userId, reportType])
}

// ============ AI ENGINE CONFIG (singleton) ============

model AiEngineConfig {
  id                  String   @id @default("singleton")
  enabled             Boolean  @default(false)
  featureToggles      Json     @default("{\"ambient\":false,\"draftNudge\":false,\"boardCoach\":false,\"predictionContext\":false,\"deepReports\":false,\"scoutReports\":false,\"sim\":false}")
  dailyTokenBudget    Int      @default(100000)
  tokensUsedToday     Int      @default(0)
  tokensUsedThisWeek  Int      @default(0)
  tokensUsedThisMonth Int      @default(0)
  lastDailyReset      DateTime @default(now())
  lastWeeklyReset     DateTime @default(now())
  lastMonthlyReset    DateTime @default(now())
  totalTokensAllTime  Int      @default(0)
  totalCallsAllTime   Int      @default(0)
  updatedAt           DateTime @default(now()) @updatedAt
}

// ============ CUSTOM LEAGUE DATA ============

model CustomLeagueData {
  id             String   @id @default(cuid())
  leagueId       String
  importedBy     String
  sourceType     String   // spreadsheet, website
  sourceFileName String?
  dataCategory   String   // standings, records, awards, trophies, draft_history,
                          // transactions, custom_stats, punishments, nicknames, other
  seasonYear     Int?
  data           Json     // Flexible JSON storage — structure varies by category
  columnMapping  Json?    // AI-generated column mapping used during import
  createdAt      DateTime @default(now())

  league League @relation(fields: [leagueId], references: [id])
  user   User   @relation(fields: [importedBy], references: [id])

  @@index([leagueId, dataCategory])
  @@index([leagueId, seasonYear])
}

// ============ LEAGUE INTELLIGENCE ============

model LeagueQuerySession {
  id        String   @id @default(cuid())
  userId    String
  leagueId  String
  messages  Json     // Array of { role, content, timestamp }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime

  user   User   @relation(fields: [userId], references: [id])
  league League @relation(fields: [leagueId], references: [id])

  @@index([userId, leagueId])
}

model LeagueStatsCache {
  id         String   @id @default(cuid())
  leagueId   String   @unique
  stats      Json     // Full pre-computed stats object
  computedAt DateTime @default(now())
  expiresAt  DateTime

  league League @relation(fields: [leagueId], references: [id])
}
